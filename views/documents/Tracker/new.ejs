<!DOCTYPE html>
<html lang="en">
<head>
    <%- include('../../partials/head.ejs', { title:"New Tracker", style:['dashboard'] }) %>
</head>
<body>
<%- include('../../partials/headbar.ejs', { title:"New Tracker" }) %>
<main>
    <section id="page-nav">
     <button type="button" onclick="history.back()">ðŸ”™ Back</button>
    </section>

    <section id="content">
        <legend>Tracker Info</legend>
        <form action="/documents/Tracker" method="POST">
            <button type="submit">Save</button>
            <label for="name">Title</label>
            <input id="name" name="name" type="text" required>
            
            <label for="description">Description</label>
            <input id="description" name="description" type="text">
            
            <label for="status">Status</label>
            <select id="status" name="status">
                <option value="ongoing">Ongoing</option>
                <option value="forthcoming">Forthcoming</option>
                <option value="complete">Complete</option>
                <option value="repayment">Repayment</option>
                <option value="funding">Funding</option>
            </select>


            <label for="members-input">Members</label>
            <input id="members-input" type="search" list="friends">
            <button type="button" id="add-friend-btn">Add</button>
            <datalist id="friends">
                <% user.profile.friends?.map(friend => { %>
                    <option data-uid="<%= friend._id %>">
                        <%= friend.displayname %>
                    </option>
                    <option data-uid="<%= friend._id %>">
                        <%= friend.username %>
                    </option>
                <% }) %>
            </datalist>
            <ul id="members-added">
            </ul>

            <button type="submit">Save</button>
        </form>
    </section>
</main>
<%- include('../../partials/navbar.ejs') %>

<script id="handle-add-members" type="text/javascript">
    const addFriend = document.getElementById('add-friend-btn');
    const membersInput = document.getElementById('members-input');
    const dataList = document.getElementById('friends');
    const membersList = document.querySelectorAll('#friends option');
    const membersAdded = document.getElementById('members-added');
    const friends = {};
    const getFriends = membersList.forEach(el => friends[el.value] = el.id);
    const members = [];
    const newNonUsers = [];
    const addedOptions = [];

    addFriend.addEventListener('click', (e) => {
        if (members.includes(friends[membersInput.value])
        || newNonUsers.includes(membersInput.value)) {
            membersInput.style.border = "1px solid #f88";
            membersInput.style.borderRadius = "3px";
            document.getElementById('session-message').textContent = "Member already added!";
            return;
        };

        membersInput.style.border = "1px solid grey";
        membersInput.style.borderRadius = "3px";
        document.getElementById('session-message').textContent = "";

        let value, reqArrNmae;
        if (Object.keys(friends).includes(membersInput.value)) {
            members.push(friends[membersInput.value])
            value = new String(friends[membersInput.value]);
            addedOptions.push(document.getElementById(value).cloneNode(true));
            document.getElementById(value).remove();
            reqArrName = 'members';
        } else {
            value = membersInput.value
            newNonUsers.push(value);
            reqArrName = 'NUmembers';
        }

        const li = document.createElement('li');
            li.classList.add(value.replace(' ', '_'));
        const text = document.createTextNode(membersInput.value);
            li.appendChild(text);
        const invisible = document.createElement('input');
            invisible.type = 'hidden';
            invisible.name = reqArrName;
            invisible.value = value;
            li.appendChild(invisible);
        const remove = document.createElement('button');
            remove.textContent = "âŒ";
            remove.classList.add('list-remove-btn');
            remove.addEventListener('click', (e) => {
                document.getElementsByClassName(value)[0].remove();
                if (reqArrName==='members') {
                    members.splice(members.find(m=>m===value),1);
                    const nodeIdx = addedOptions.findIndex(n=>n.id==value);
                    dataList.appendChild(addedOptions[nodeIdx]);
                    addedOptions.splice(nodeIdx,1);
                }
            });
            li.appendChild(remove);
        membersAdded.appendChild(li);

        console.log(addedOptions);

        membersInput.value = '';
    })
</script>
</body>
</html>